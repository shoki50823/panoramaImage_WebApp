
# WebcamProcDemo
スマホで撮った写真をサーバで処理して返してくるプログラムのデモ．


## ファイル構成
- cert: https通信を行うためのオレオレ証明書が格納されるディレクトリ
- post-images: スマホから送信された画像が格納されるディレクトリ
- result-images: 処理済みの画像が格納されるディレクトリ
- static
    - loading.gif: ロード中のぐるぐるアニメーションgif
- views
    - *.tpl: HTMLテンプレートファイル
- imgproc.py: 画像をぼかすスクリプト
- server.py: サーバスクリプト


## 依存ライブラリ
- bottle
- opencv-python（デモのために画像をぼかすためだけに使用，コアな部分には必要なし）


## 使い方
### 前準備
https通信を行うために，オレオレ証明書を生成する．
以下のコマンドを実行して，certディレクトリに秘密鍵と公開鍵を生成する．

```
$ mkdir cert
$ cd cert
$ openssl genrsa 2048 > server.key
$ openssl req -new -key server.key > server.csr
$ openssl x509 -days 365 -req -signkey server.key < server.csr > server.crt
```


### 動かし方
1. サーバスクリプトserver.pyを起動する
    - 使っているウイルス対策ソフトによっては，ファイアウォールで443/tcpに穴を開ける必要があるかも
1. スマホのブラウザ（Chromeのみ動作確認済み）からサーバスクリプトを動作させているマシンにアクセスする
    - https://192.168.1.XXX のように必ずhttpsでアクセスすること
1. ブラウザで開いたページを使って写真を撮って送信する
1. しばらくした後に処理結果の画像が返ってくる


## 改造の手引き
サーバ側で行う処理を変更する改造について説明する．

画像処理は ```server.py``` スクリプト内の ```process_images``` 関数で行われる．
この関数を書き換えることで，処理内容を変更できる．
引数として入力画像のパスと処理済み画像の保存パスを示す ```input_img_path``` ， ```output_img_path``` の
2つの引数を受け取る．
処理済みの画像は必ず ```output_img_path``` に示されるパスに保存しなければならない．

また，この関数は即座に処理を返すべきである．
長時間に渡る処理を行う場合は別プロセスを起動して処理を行うなど，非同期的に処理を行わなければならない．
関数から処理が返らない間はHTTPサーバが停止するため，新たなリクエストを受け付けたり，HTMLページを返すことができなくなり，
スマホ側からはフリーズしたかのように見えてしまう．


